%This is the main script to check whether the ECoG data are sufficiently
%time-locked, by first testing whether there is an evoked response and then
%extracting those components related to the visual response.
%Project: ECoG_WM
%Author: D.T.
%Date: 09 December 2019

clear all;
close all;
clc;

%% Add relevant paths
ECoG_setPath;

%% Define important variables

tmin = -0.42;
tmax = 4.5;

time = [tmin : 0.001 : tmax];

%% Define important variables
subnips = {'EG_I', 'HS', 'KJ_I', 'LJ', 'MG', 'MKL', 'SB', 'WS', 'KR', 'AS', 'AP', 'HL'}; %subject KR has a different sampling frequency, to be checked carefully
%subnips = {'EG_I'};

%% Load data
for subi = 1 : length(subnips)
    
    %Load initial data
    load([res_path subnips{subi} '/' subnips{subi} '_reref.mat']);
    
    for triali = 1 : length(reref.time)
        begin_t(triali) = reref.time{triali}(1);
    end
    
    if numel(unique(begin_t))
       display('ATTENTION! Adjusting time axis to facilitate following analyses');
            
       my_difference = begin_t - (-.45); 
            
       %Adjust be measured differences
       for triali = 1 : length(reref.time)
           tmp{triali} = reref.time{triali} - my_difference(triali);
       end
            
       %Re-check
       for triali = 1 : length(reref.time)
           begin_t2(triali) = tmp{triali}(1);
       end
            
       display(num2str(unique(begin_t2(triali))));
            
       pause;
            
       reref.time = tmp;
    end
    
    %Extract ERPs
    cfg = [];
    cfg.lpfilter = 30; %lowpass data at 30 Hz
    
    tmp = ft_preprocessing(cfg, reref);
    
    %cfg = [];
    %cfg.resamplefs = 250;
    %cfg.detrend = 'no'; %detrending should only be used prior to TFA analysis, but not when looking at evoked fields
    
    %tmp2 = ft_resampledata(cfg, tmp);
    
    cfg = [];
    cfg.latency = [tmin, tmax];
    
    erp{subi} = ft_timelockanalysis(cfg, tmp);
    
    clear ('tmp');
    
    %Plot individual subjects' erps
    figure;
    plot(time, squeeze(mean(erp{subi}.avg)));
    
    pause;
end